{% comment %}
  Win98 Taskbar Section
  Renders an authentic Windows 98 taskbar at the bottom of the page
{% endcomment %}

{{ 'win98-taskbar.css' | asset_url | stylesheet_tag }}
<script src="{{ 'win98-taskbar.js' | asset_url }}" defer></script>

{%- liquid
  assign current_page_name = 'Desktop'
  case request.page_type
    when 'index'
      assign current_page_name = 'Home'
    when 'collection'
      assign current_page_name = collection.title
    when 'product'
      assign current_page_name = product.title
    when 'page'
      assign current_page_name = page.title
    when 'blog'
      assign current_page_name = blog.title
    when 'article'
      assign current_page_name = article.title
    when 'cart'
      assign current_page_name = 'Shopping Cart'
    when 'search'
      assign current_page_name = 'Search'
  endcase
-%}

<div class="win98-taskbar" id="win98-taskbar" style="--taskbar-height: {{ section.settings.taskbar_height | default: 28 }}px; --mobile-taskbar-height: {{ section.settings.mobile_taskbar_height | default: 32 }}px;">
  <!-- Start Button -->
  <div class="taskbar-start">
    <button class="start-button" id="start-button" type="button" aria-expanded="false" aria-haspopup="true">
      {%- if section.settings.start_logo != blank -%}
        <img src="{{ section.settings.start_logo | image_url: width: 16, height: 16 }}" alt="{{ section.settings.start_text | default: 'Start' }}" class="start-logo">
      {%- else -%}
        <span class="start-icon">üèÅ</span>
      {%- endif -%}
      <span class="start-text">{{ section.settings.start_text | default: 'Start' }}</span>
    </button>
  </div>

  {%- if section.settings.show_quick_launch and section.blocks.size > 0 -%}
    <!-- Quick Launch Separator -->
    <div class="quick-launch-separator"></div>
    
    <!-- Quick Launch Bar -->
    <div class="quick-launch-bar">
      {%- for block in section.blocks -%}
        {%- if block.type == 'quick_launch_item' -%}
          <a 
            href="{{ block.settings.link }}" 
            class="quick-launch-item" 
            title="{{ block.settings.title | escape }}"
            {%- if block.settings.open_in_new_tab %} target="_blank" rel="noopener"{% endif -%}
            {{ block.shopify_attributes }}
          >
            <span class="quick-launch-icon">{{ block.settings.icon }}</span>
            {%- unless section.settings.quick_launch_icons_only -%}
              <span class="quick-launch-text">{{ block.settings.title | escape }}</span>
            {%- endunless -%}
          </a>
        {%- endif -%}
      {%- endfor -%}
    </div>
  {%- endif -%}

  <!-- Start Menu -->
  <div class="start-menu" id="start-menu" role="menu" aria-hidden="true">
    {%- if section.settings.main_menu != blank -%}
      {%- for link in linklists[section.settings.main_menu].links -%}
        {%- render 'win98-navigation-item', 
            link: link, 
            show_icons: section.settings.show_icons, 
            level: 0 -%}
      {%- endfor -%}
    {%- else -%}
      <!-- Fallback navigation if no menu selected -->
      <div class="menu-item" role="menuitem">
        <a href="/" class="menu-link">
          <span class="menu-icon">üè†</span>
          <span class="menu-text">Home</span>
        </a>
      </div>
      <div class="menu-item" role="menuitem">
        <a href="/collections/all" class="menu-link">
          <span class="menu-icon">üõçÔ∏è</span>
          <span class="menu-text">Shop All</span>
        </a>
      </div>
      <div class="menu-separator"></div>
      <div class="menu-item" role="menuitem">
        <a href="/account" class="menu-link">
          <span class="menu-icon">üë§</span>
          <span class="menu-text">Account</span>
        </a>
      </div>
      <div class="menu-item" role="menuitem">
        <a href="/pages/contact" class="menu-link">
          <span class="menu-icon">‚ùì</span>
          <span class="menu-text">Help</span>
        </a>
      </div>
    {%- endif -%}
    
    <!-- Always show separator and search at bottom -->
    <div class="menu-separator"></div>
    <div class="menu-item" role="menuitem">
      <button type="button" class="menu-link" onclick="document.getElementById('search-button')?.click()" role="button">
        <span class="menu-icon">üîç</span>
        <span class="menu-text">Search...</span>
      </button>
    </div>
  </div>

  <!-- Application Area -->
  <div class="taskbar-apps">
    {%- if section.settings.show_current_page -%}
      <div class="taskbar-app active" title="{{ current_page_name }}">
        <span class="app-icon">ü™ü</span>
        <span class="app-text">{{ current_page_name | truncate: 20 }}</span>
      </div>
    {%- endif -%}
  </div>

  <!-- System Tray -->
  <div class="system-tray">
    {%- if section.settings.show_search -%}
      <button class="tray-item" id="search-button" type="button" title="Search">
        <span class="tray-icon">üîç</span>
      </button>
    {%- endif -%}

    {%- if section.settings.show_cart -%}
      <button class="tray-item" id="cart-button" type="button" title="Shopping Cart" onclick="document.querySelector('cart-drawer')?.open()">
        <span class="tray-icon">üõí</span>
        {%- if cart.item_count > 0 -%}
          <span class="cart-count">{{ cart.item_count }}</span>
        {%- endif -%}
      </button>
    {%- endif -%}

    {%- if section.settings.show_account -%}
      <a href="{{ routes.account_url }}" class="tray-item" title="Account">
        <span class="tray-icon">üë§</span>
      </a>
    {%- endif -%}

    {%- if section.settings.show_clock -%}
      <div class="system-clock" id="system-clock">
        <div class="clock-time">12:00</div>
        <div class="clock-date">1/1</div>
      </div>
    {%- endif -%}
  </div>
</div>

{%- if section.settings.show_search -%}
  <!-- Search Dialog Backdrop -->
  <div class="search-dialog-backdrop" id="search-dialog-backdrop"></div>
  
  <!-- Search Dialog -->
  <div class="search-dialog window" id="search-dialog" style="display: none;">
    <div class="title-bar">
      <div class="title-bar-text">Search for Products</div>
      <div class="title-bar-controls">
        <button aria-label="Close" id="close-search"></button>
      </div>
    </div>
    <div class="window-body">
      <form action="{{ routes.search_url }}" method="get" role="search">
        <div class="field-row">
          <label for="search-input">Search products:</label>
          <input type="search" id="search-input" name="q" value="{{ search.terms | escape }}" placeholder="Enter search terms...">
        </div>
        <div class="field-row" style="justify-content: flex-end;">
          <button type="submit" class="search-submit">Search</button>
          <button type="button" id="cancel-search">Cancel</button>
        </div>
      </form>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Win98 Taskbar",
  "class": "win98-taskbar-section",
  "settings": [
    {
      "type": "header",
      "content": "Start Button"
    },
    {
      "type": "image_picker",
      "id": "start_logo",
      "label": "Start button logo",
      "info": "Upload your logo for the Start button. If no logo is uploaded, a Windows flag icon will be shown."
    },
    {
      "type": "text",
      "id": "start_text",
      "label": "Start button text",
      "default": "Start",
      "info": "Customize the text shown on the Start button"
    },
    {
      "type": "header",
      "content": "Start Menu Navigation"
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Main navigation menu",
      "default": "main-menu",
      "info": "Select the navigation menu to display in the Start menu"
    },
    {
      "type": "checkbox",
      "id": "show_icons",
      "label": "Show navigation icons",
      "default": true,
      "info": "Display icons next to navigation items"
    },
    {
      "type": "header",
      "content": "Quick Launch Bar"
    },
    {
      "type": "checkbox",
      "id": "show_quick_launch",
      "label": "Show quick launch bar",
      "default": true,
      "info": "Display quick launch buttons next to the Start button"
    },
    {
      "type": "checkbox",
      "id": "quick_launch_icons_only",
      "label": "Show icons only",
      "default": false,
      "info": "Hide text labels and show only icons in quick launch"
    },
    {
      "type": "header",
      "content": "Taskbar Settings"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        {
          "value": "bottom",
          "label": "Bottom"
        },
        {
          "value": "top", 
          "label": "Top"
        }
      ],
      "default": "bottom"
    },
    {
      "type": "range",
      "id": "taskbar_height",
      "label": "Taskbar height",
      "min": 24,
      "max": 48,
      "step": 2,
      "unit": "px",
      "default": 28,
      "info": "Adjust the height of the taskbar. Default is 28px for authentic Win98 size."
    },
    {
      "type": "range",
      "id": "mobile_taskbar_height",
      "label": "Mobile taskbar height",
      "min": 24,
      "max": 48,
      "step": 2,
      "unit": "px",
      "default": 32,
      "info": "Adjust the height of the taskbar on mobile devices."
    },
    {
      "type": "checkbox",
      "id": "show_current_page",
      "label": "Show current page as active application",
      "default": true
    },
    {
      "type": "header",
      "content": "System Tray"
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "Show search",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_cart",
      "label": "Show shopping cart",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_account",
      "label": "Show account",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_clock",
      "label": "Show system clock",
      "default": true
    },
    {
      "type": "header",
      "content": "Mobile Settings"
    },
    {
      "type": "select",
      "id": "mobile_behavior",
      "label": "Mobile behavior",
      "options": [
        {
          "value": "mini",
          "label": "Mini taskbar"
        },
        {
          "value": "hidden",
          "label": "Hidden"
        },
        {
          "value": "drawer",
          "label": "Drawer menu"
        }
      ],
      "default": "mini"
    }
  ],
  "blocks": [
    {
      "type": "quick_launch_item",
      "name": "Quick Launch Item",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Quick Link",
          "info": "Text shown on hover and as button label"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link URL"
        },
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            {
              "value": "üõçÔ∏è",
              "label": "Shop"
            },
            {
              "value": "üìÇ",
              "label": "Collections"
            },
            {
              "value": "üè∑Ô∏è", 
              "label": "Sale"
            },
            {
              "value": "‚ú®",
              "label": "New"
            },
            {
              "value": "üë§",
              "label": "Account"
            },
            {
              "value": "‚ùì",
              "label": "Help"
            },
            {
              "value": "üìû",
              "label": "Contact"
            },
            {
              "value": "üîç",
              "label": "Search"
            },
            {
              "value": "üõí",
              "label": "Cart"
            },
            {
              "value": "üì∞",
              "label": "Blog"
            },
            {
              "value": "üè†",
              "label": "Home"
            },
            {
              "value": "‚öôÔ∏è",
              "label": "Settings"
            },
            {
              "value": "üì¶",
              "label": "Products"
            },
            {
              "value": "üìÑ",
              "label": "Page"
            }
          ],
          "default": "üõçÔ∏è"
        },
        {
          "type": "checkbox",
          "id": "open_in_new_tab",
          "label": "Open in new tab",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Win98 Taskbar",
      "settings": {
        "main_menu": "main-menu",
        "show_icons": true,
        "show_quick_launch": true,
        "show_current_page": true,
        "show_search": true,
        "show_cart": true,
        "show_account": true,
        "show_clock": true
      },
      "blocks": [
        {
          "type": "quick_launch_item",
          "settings": {
            "title": "Shop All",
            "link": "/collections/all",
            "icon": "üõçÔ∏è"
          }
        },
        {
          "type": "quick_launch_item",
          "settings": {
            "title": "Account",
            "link": "/account",
            "icon": "üë§"
          }
        },
        {
          "type": "quick_launch_item",
          "settings": {
            "title": "Help",
            "link": "/pages/contact",
            "icon": "‚ùì"
          }
        }
      ]
    }
  ]
}
{% endschema %}